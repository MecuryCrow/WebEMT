{% extends "layout.html" %}
{% block content %}

<h2>System Status</h2>

<div class="card bg-dark p-4 shadow">

    <h4>Capture Engine</h4>

    {% if status.mitm_running and status.dumpcap_running %}
    <p class="text-success fw-bold">● Running</p>
    {% else %}
    <p class="text-danger fw-bold">● Not Running</p>
    {% endif %}

    {% if status.alert_active %}
    <p class="text-warning fw-bold">⚠ ALERT TRIGGERED</p>
    <p>Event Timestamp: {{ status.alert_timestamp }}</p>

    <!-- Countdown timer -->
    <div class="mt-3">
        <h5 class="text-info">Future 10-minute Capture Window</h5>
        <p id="countdown" class="fw-bold fs-4 text-light"></p>
    </div>

    <a class="btn btn-warning mt-3" href="/urls">View Captured URLs</a>

    <script>
        const futureEnd = Number("{{ status.future_capture_end }}") * 1000;

        function updateCountdown() {
            let now = Date.now();
            let diff = futureEnd - now;

            if (diff <= 0) {
                document.getElementById("countdown").innerHTML =
                    "✔ Future capture complete";
                return;
            }

            let mins = Math.floor(diff / 60000);
            let secs = Math.floor((diff % 60000) / 1000);

            document.getElementById("countdown").innerHTML =
                mins.toString().padStart(2, '0') + ":" +
                secs.toString().padStart(2, '0');

            setTimeout(updateCountdown, 500);
        }

        updateCountdown();
    </script>

    {% else %}
    <p class="text-muted">Waiting for alert...</p>
    {% endif %}

</div>

{% endblock %}